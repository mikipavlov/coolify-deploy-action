name: "Deploy to Coolify"
description: "Trigger Coolify deployment and poll for completion"
author: "mikipavlov"

inputs:
  domain:
    description: "Coolify instance domain (e.g., https://coolify.example.com)"
    required: true
  uuid:
    description: "Application UUID to deploy"
    required: true
  token:
    description: "Coolify API token"
    required: true

runs:
  using: "composite"
  steps:
    - name: Deploy
      shell: bash
      env:
        COOLIFY_DOMAIN: ${{ inputs.domain }}
        COOLIFY_UUID: ${{ inputs.uuid }}
        COOLIFY_TOKEN: ${{ inputs.token }}
      run: |
        set -euo pipefail

        domain=$(sed 's:/*$::' <<< "$COOLIFY_DOMAIN")
        trigger_url="$domain/api/v1/deploy?uuid=$COOLIFY_UUID"

        echo "üöÄ Triggering deployment..."
        echo "   URL: $trigger_url"

        set +e
        http_code=$(curl -s -w "%{http_code}" -o /tmp/trigger.json \
          -H "Authorization: Bearer $COOLIFY_TOKEN" \
          -H "Content-Type: application/json" \
          "$trigger_url" 2>/tmp/err.txt)
        curl_exit=$?
        set -e

        response=$(cat /tmp/trigger.json 2>/dev/null || echo "")

        if [[ $curl_exit -ne 0 ]]; then
          echo "‚ùå Curl error: $(cat /tmp/err.txt 2>/dev/null || echo 'unknown')"
          exit 1
        elif [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
          echo "‚ùå Trigger failed with HTTP $http_code"
          echo "   Response: $response"
          exit 1
        fi

        deployment_uuid=$(jq -r '.deployments[0].deployment_uuid' <<< "$response")
        echo "‚úÖ Deployment triggered: $deployment_uuid"

        poll_url="$domain/api/v1/deployments/$deployment_uuid"
        echo "üì° Polling: $poll_url"

        error_count=0
        empty_count=0

        for i in {1..60}; do
          set +e
          http_code=$(curl -s -w "%{http_code}" -o /tmp/res.json \
            -H "Authorization: Bearer $COOLIFY_TOKEN" \
            "$poll_url" 2>/tmp/err.txt)
          curl_exit=$?
          set -e

          response=$(cat /tmp/res.json 2>/dev/null || echo "")
          echo "[Poll $i/60] HTTP=$http_code curl_exit=$curl_exit"

          if [[ $curl_exit -ne 0 ]]; then
            error_count=$((error_count + 1))
            echo "   ‚ö†Ô∏è Curl error: $(cat /tmp/err.txt 2>/dev/null || echo 'unknown')"
          elif [[ -z "$http_code" ]]; then
            error_count=$((error_count + 1))
            echo "   ‚ö†Ô∏è Empty HTTP code"
          elif [[ "$http_code" == "404" ]]; then
            echo "   ‚è≥ Deployment not found yet..."
            error_count=0
          elif [[ "$http_code" == "403" ]]; then
            echo "   ‚ùå Permission denied (403)"
            echo "   Response: $response"
            echo "   Hint: API token needs 'read' permission"
            exit 1
          elif [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
            error_count=$((error_count + 1))
            echo "   ‚ö†Ô∏è HTTP $http_code: $response"
          else
            error_count=0
            status=$(jq -r '.status // empty' <<< "$response" 2>/dev/null || echo "")
            echo "   Status: '$status'"

            case "$status" in
              finished)
                echo "‚úÖ Deployment completed successfully"
                exit 0
                ;;
              failed|cancelled|cancelled-by-user)
                echo "‚ùå Deployment failed: $status"
                exit 1
                ;;
              in_progress|queued)
                : ;;
              "")
                empty_count=$((empty_count + 1))
                [[ $empty_count -ge 10 ]] && { echo "‚ÑπÔ∏è Status empty 10x, assuming success"; exit 0; }
                ;;
              *)
                echo "   ‚ùì Unknown status: $status"
                ;;
            esac
          fi

          [[ $error_count -ge 5 ]] && { echo "‚ùå Too many errors"; exit 1; }
          sleep 3
        done

        echo "‚ùå Deployment polling timed out"
        exit 1
